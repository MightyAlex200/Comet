<html>

<head>
    <title>Comet</title>
    <meta charset="utf-8" />
</head>

<body>
    <div id="elm"></div>
    <script src="/index.js"></script>
    <script src="/hc-web-client-0.4.0.browser.min.js"></script>
    <script>
        const instanceId = "test-instance";
        const connectionUrl = "ws://localhost:8888/";

        const app = Elm.Main.init();
        function getFuncPath({ zome, functionName }) {
            return "test-instance/" + zome + "/" + functionName;
        }

        // Connect ports
        app.ports.saveSettingsPort.subscribe(settings => {
            window.localStorage.setItem('settings', JSON.stringify(settings));
            app.ports.settingsUpdated.send(settings);
        });

        const settings = localStorage.getItem('settings');
        if (settings) {
            app.ports.settingsUpdated.send(JSON.parse(settings));
        }

        holochainclient.connect(connectionUrl).then(({ callZome, close }) => {
            app.ports.callFunction.subscribe(msg => {
                callZome(instanceId, msg.functionInfo.zome, msg.functionInfo.functionName)(msg.value).then(response => {
                    app.ports.functionReturned.send({
                        "functionInfo": msg.functionInfo,
                        "return": JSON.parse(response),
                        "id": msg.id,
                    });
                });
            });
        });
    </script>
</body>

</html>